<!DOCTYPE html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Rockstar Chat</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
            <link rel="stylesheet" type="text/css" href="css/style.css">
            <script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
            <script src="http://cdn.mlkcca.com/v2.1/milkcocoa.js"></script>
            <script src="js/rview.js"></script>
            <script src="js/rchat.js"></script>
            <script>
            $(function() {
                //1.ミルクココアインスタンスを作成
                var milkcocoa = new MilkCocoa("https://mlkcca.com", "mlkdev-000l", function() {});

                rview.view("top", ['<div class="row">',
                    '<textarea id="room-name" cols="32" class="room-name" placeholder="部屋の名前を入力してください。"></textarea>',
                    '<button id="create" class="create-btn">チャットルームの作成</button>',
                    '</div>',
                    '<div class="row">',
                    '<div id="rooms" class="room-list">',
                    '</div>',
                    '</div>'
                    ], function(args) {
                        location.hash = "";
                        $('#create').click(function() {
                            var ds = milkcocoa.dataStore('room');
                            ds.push({
                                name : $('#room-name').val()
                            }, function(e) {
                                rview.transition("chat", {room_id : e.value.id});
                                add_room(e.value.id, e.value.name);
                            });
                        });
                        var rooms = get_rooms();
                        for(var i=0;i < rooms.length;i++) {
                            $('#rooms').append('<div name="room-item" class="room-item" data-cid="'+rooms[i].id+'">' + rooms[i].name + '</div>');
                        }
                        $('[name="room-item"]').click(function() {
                            var room_id = $(this).data('cid');
                            rview.transition("chat", {room_id : room_id});
                        })
                });
                rview.view("chat", [
                    '<div class="row">',
                    '<button class="return-btn">戻る</button>',
                    '</div>',
                    '<div class="row">',
                    '<textarea id="message-content" cols="32" class="post-area" placeholder="Enterで投稿"></textarea>',
                    '<button id="post" class="post-btn">投稿</button>',
                    '</div>',
                    '<div class="row">',
                    '<div id="messages" class="message-list">',
                    '<div id="dummy"></div>',
                    '</div>',
                    '</div>'
                    ], function(args) {
                        location.hash = args.room_id;
                        init_chat_room(milkcocoa, args.room_id);
                        $('.return-btn').click(function() {
                            rview.transition("top", {});
                        })
                });

                var room_id = location.hash.substr(1);
                if(room_id) {
                    rview.transition("chat", {room_id : room_id});
                }else{
                    rview.transition("top", {});
                }

            });
            //インジェクション対策
            function escapeHTML(val) {
                return $('<div>').text(val).html();
            };
            </script>
    </head>
    <body>
        <div class="container">
            <div class="row">
                <h2>Chat Application</h2>
            </div>
            <div id="content">
            </div>
            <footer>
                Powerd by <a href="https://mlkcca.com">milkcocoa</a>.
            </footer>
        </div>
    </body>
</html>
